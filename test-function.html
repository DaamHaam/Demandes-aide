<!doctype html>
<meta charset="utf-8">
<title>Test Supabase Edge Function — generate-tts</title>
<style>
  body{font:16px/1.45 system-ui,Segoe UI,Roboto,Arial;margin:24px;max-width:780px}
  label{display:block;margin:.6rem 0 .25rem}
  input,textarea,button{font:inherit;padding:.6rem;border:1px solid #d0d7de;border-radius:10px;width:100%}
  textarea{min-height:80px}
  button{cursor:pointer;background:#0d6efd;border-color:#0d6efd;color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .log{white-space:pre-wrap;background:#f6f7f9;padding:10px;border-radius:10px;border:1px solid #e6e8eb}
</style>

<h1>Test — generate-tts (Supabase Edge Function)</h1>

<label>Functions URL</label>
<input id="fn" value="https://zfqpbddopgrqbsgizith.functions.supabase.co/generate-tts">

<label>Anon key (publique)</label>
<input id="anon" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcXBiZGRvcGdycWJzZ2l6aXRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MDgzMjQsImV4cCI6MjA3NTE4NDMyNH0.skmx5Y_JQegnqJn2t2uE3qyWokLS0IK2L_YAvWQHW2Q">

<div class="row">
  <div>
    <label>Texte à synthétiser</label>
    <textarea id="text">Je voudrais boire.</textarea>
  </div>
  <div>
    <label>Voice ID (optionnel si défini en secret)</label>
    <input id="voice" placeholder="ex: 21m00Tcm4TlvDq8ikWAM">
  </div>
</div>

<p><button id="go">Générer et lire</button></p>

<h3>Réponse</h3>
<pre class="log" id="out">—</pre>

<audio id="player" controls></audio>

<script>
const $ = s => document.querySelector(s);

$('#go').onclick = async () => {
  const url  = $('#fn').value.trim();
  const anon = $('#anon').value.trim();
  const text = $('#text').value.trim();
  const voice= $('#voice').value.trim();

  $('#go').disabled = true;
  $('#out').textContent = 'Envoi…';

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + anon,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ text, lang: 'fr-FR', voice_id: voice || undefined })
    });

    const jsonText = await res.text();
    let json;
    try { json = JSON.parse(jsonText); } catch { json = { raw: jsonText }; }

    $('#out').textContent = JSON.stringify(json, null, 2);

    if (res.ok && json.mp3_url) {
      const audio = $('#player');
      audio.src = json.mp3_url;
      audio.play().catch(()=>{});
    }
  } catch (e) {
    $('#out').textContent = 'Erreur fetch: ' + e;
  } finally {
    $('#go').disabled = false;
  }
};
</script>
