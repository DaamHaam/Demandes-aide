name: Pages (prod, beta, PR previews)

on:
  push:
    branches: [ main, Next ]
  pull_request:
    branches: [ Next ]

permissions:
  contents: write        # push sur gh-pages
  pull-requests: write   # commenter l'URL de preview

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # DÃ©ploie la PROD Ã  la racine de gh-pages
      - name: Deploy production to gh-pages root
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          keep_files: true      # conserve /beta et /beta/pr-*

  deploy-beta:
    if: github.ref == 'refs/heads/Next'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # DÃ©ploie la BÃŠTA sous /beta
      - name: Deploy beta to gh-pages/beta
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          destination_dir: beta
          keep_files: true      # prÃ©serve la racine (prod) et les previews

  pr-preview:
    if: github.event_name == 'pull_request' && github.base_ref == 'Next'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      # DÃ©ploie la PR sous /beta/pr-<num>/
      - name: Deploy PR preview
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          destination_dir: beta/pr-${{ github.event.number }}
          keep_files: true

      # Commente l'URL de la preview sur la PR (commentaire "sticky")
      - name: Compute repo vars
        id: vars
        run: |
          echo "REPO_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
      - name: Create comment body
        run: |
          echo "ðŸš€ PrÃ©version dÃ©ployÃ©e : https://${{ github.repository_owner }}.github.io/${REPO_NAME}/beta/pr-${{ github.event.number }}/" > preview-comment.md
      - name: Comment preview URL
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: preview-comment.md
